{% extends "base.html" %}
{% load static %}

{% block title %}Create Blood Request{% endblock %}

{% block content %}
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

<!-- Background image -->
<div class="bg-image"></div>

<!-- Glassmorphic container -->
<div class="form-container">
  <form method="POST" id="bloodRequestForm" class="glass-form">
    {% csrf_token %}
    <h2>Create Blood Request</h2>

    {% for field in form %}
      {% if field.name != "requester_lat" and field.name != "requester_lng" %}
      <div class="mb-3">
        <label class="form-label">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
          <div class="form-text">{{ field.help_text }}</div>
        {% endif %}
        {% for error in field.errors %}
          <div class="text-danger">{{ error }}</div>
        {% endfor %}
      </div>
      {% endif %}
    {% endfor %}

    <!-- Hidden fields -->
    <input type="hidden" name="requester_lat" id="id_requester_lat">
    <input type="hidden" name="requester_lng" id="id_requester_lng">

    <button type="submit" class="btn-primary">Create Request</button>
    <a href="{% url 'blood_requests:request_list' %}" class="btn-secondary">Cancel</a>
  </form>

  <!-- Search + Map -->
  <div class="map-section mt-4">
    <input type="text" id="search" class="search-input" placeholder="Search village or city in your district">
    <button class="btn-primary" type="button" onclick="searchLocation()">Search</button>
    <div id="map"></div>
    <p><strong>Tip:</strong> Drag the marker to adjust your location if needed.</p>
  </div>
</div>

<!-- Styles -->
<style>
  /* Fonts */
  body, input, select, textarea, button, .form-label, .form-text, p {
    font-family: 'Roboto', sans-serif;
    font-weight: 400;
  }

  h2 {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    letter-spacing: 1px;
    color: #fbc02d;
  }

  /* Background */
  .bg-image {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-image: url("{% static 'images/background.jpg' %}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: brightness(0.7);
    z-index: 1;
  }

  /* Container */
  .form-container {
    position: relative;
    z-index: 2;
    max-width: 900px;
    margin: 50px auto;
    padding: 30px;
  }

  /* Glassmorphic form */
  .glass-form {
    background: rgba(255, 255, 255, 0.25); 
    box-shadow: 0 8px 32px rgba(251, 192, 45, 0.37);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    padding: 30px;
    color: #fbc02d;
    margin-bottom: 20px;
  }

  .glass-form h2 {
    text-align: center;
    margin-bottom: 25px;
  }

  .glass-form input, .glass-form select, .glass-form textarea {
    width: 100%;
    margin-bottom: 15px;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid #fbc02d;
    background: rgba(255, 255, 255, 0.4);
    font-size: 16px;
    font-family: 'Roboto', sans-serif;
    color: #fbc02d;
    transition: all 0.3s ease;
  }

  .glass-form input:focus, .glass-form select:focus, .glass-form textarea:focus {
    border-color: #ffeb3b;
    outline: none;
    background: rgba(255, 255, 255, 0.6);
  }

  /* Buttons */
  .btn-primary, .btn-secondary {
    display: inline-block;
    padding: 12px 22px;
    border-radius: 10px;
    font-size: 16px;
    text-decoration: none;
    margin-right: 10px;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    transition: 0.3s ease;
  }

  .btn-primary {
    background: #fbc02d;
    color: white;
    border: none;
  }

  .btn-primary:hover {
    background: #ffeb3b;
  }

  .btn-secondary {
    background: rgba(255,255,255,0.5);
    color: #fbc02d;
    border: 1px solid #fbc02d;
  }

  .btn-secondary:hover {
    background: rgba(255,255,150,0.5);
  }

  /* Map section */
  .map-section {
    background: rgba(255,255,255,0.2);
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
    margin-top: 20px;
    border: 1px solid rgba(251,192,45,0.3);
  }

  #map {
    height: 400px;
    border-radius: 12px;
    margin-top: 10px;
  }

  .search-input {
    width: calc(100% - 120px);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #fbc02d;
    margin-right: 10px;
    font-family: 'Roboto', sans-serif;
    font-size: 16px;
    color: #fbc02d;
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker;
const defaultLat = 17.0;
const defaultLng = 82.0;

function updateHiddenFields(lat, lng) {
    document.getElementById("id_requester_lat").value = lat;
    document.getElementById("id_requester_lng").value = lng;
}

function initMap(lat, lng) {
    map = L.map('map').setView([lat, lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker([lat, lng], {draggable: true}).addTo(map)
        .bindPopup("Drag to adjust your exact location")
        .openPopup();

    updateHiddenFields(lat, lng);

    marker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        updateHiddenFields(pos.lat, pos.lng);
    });
}

// Try browser geolocation
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        initMap(position.coords.latitude, position.coords.longitude);
    }, function(error) {
        console.warn("Geolocation failed:", error.message);
        initMap(defaultLat, defaultLng);
    }, {enableHighAccuracy: true});
} else {
    initMap(defaultLat, defaultLng);
}

// Search restricted to India
function searchLocation() {
    const query = document.getElementById("search").value.trim();
    if (!query) { alert("Enter a location"); return; }

    const viewbox = "81.5,16.0,82.5,17.5"; // Adjust to your district bounding box

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=${viewbox}&bounded=1&countrycodes=IN`)
    .then(res => res.json())
    .then(data => {
        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            updateHiddenFields(lat, lng);
        } else {
            alert("Location not found in your district or in India.");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error searching location.");
    });
}

// Ensure hidden fields update before submit
document.getElementById("bloodRequestForm").addEventListener("submit", function(e) {
    if (marker) {
        const pos = marker.getLatLng();
        updateHiddenFields(pos.lat, pos.lng);
    }
});
</script>
{% endblock %}
